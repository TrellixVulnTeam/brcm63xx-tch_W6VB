/* pianod web client - communication class
   Copr. 2013 Perette Barella/Devious Fish
   All rights reserved.
*//* Message number definitions */function PianoConnection(e,t,n){function v(e,t){var n=s[u];delete s[u++],typeof n.handler=="function"&&n.handler(e,t)}function m(e){i&&console.log(e.data);var t=parseInt(e.data.substring(0,3),10),n=e.data.substring(4),s=n.split(": ");s.splice(0,1);var o=s.join(": ");if(t==MSG.DATA_START)p=MSG.STATE_COMMAND,Object.keys(f).length>0&&(a.push(f),f={});else if(t>=MSG.SUCCESS_START&&t<=MSG.SUCCESS_END||t>=MSG.ERROR_START&&t<=MSG.ERROR_END)p==MSG.STATE_COMMAND&&t!=MSG.DATA_END&&console.log("Received ",t," instead of ",MSG.DATA_END),p=r.DISCRETE,Object.keys(f).length>0&&(a.push(f),f={}),v(t,t>=MSG.SUCCESS_START&&t<=MSG.SUCCESS_END?a:n),a=[];if(p==r.DISCRETE){var u=l[t]||[];for(var h=0;h<u.length;h++)u[h](t,n,o);c[t]={code:t,message:n,data:o}}else t>=MSG.INFO_START&&t<=MSG.INFO_END&&(t in f&&(a.push(f),f={}),f[t]=o)}function g(e){for(var t=h.length-1;t>=0;t--)h[t](e)}var r={COMMAND:1,DISCRETE:2},i=0,s={0:{id:0,command:"connect",handler:t||""}},o=1,u=0,a=[],f={},l={},c={},h=[],p=r.DISCRETE,d=new WebSocket(e);return typeof n=="function"&&h.push(n),d.onmessage=function(e){m(e)},d.onopen=function(e){},d.onclose=function(e){g(e)},d.onerror=function(e){g(e)},{request_time_status:function(){d.send(" ")},send_command:function(e,t){typeof e=="object"&&(e='"'+e.join('" "')+'"'),t=t||"";var n={id:o,command:e,handler:t};s[o++]=n,d.send(e)},on_close:function(e){h.push(e)},subscribe:function(e,t,n){typeof e!="object"&&(e=[e]),n=n||!0;for(var r=0;r<e.length;r++){code=e[r],code in l||(l[code]=[]),l[code].push(t),i&&console.log("subscribed ",t," to ",code);if(n&&code in c){var s=c[code];t(s.code,s.message,s.data)}}},is_success:function(e){return e>=MSG.SUCCESS_START&&e<=MSG.SUCCESS_END},is_error:function(e){return e>=MSG.ERROR_START&&e<=MSG.ERROR_END},get_sorted_column:function(e,t){var n=[];for(var r=0;r<e.length;r++)n.push(e[r][t]);return n.sort(function(e,t){var n=e.toLowerCase(),r=t.toLowerCase();return n<r?-1:n>r?1:0}),n},get_word_flags:function(e,t){var n={},r=t.split(/\s+/);for(var i=0;i<e.length;i++){var s=e[i];n[s]=r.indexOf(s)>=0}return n}}}function PianodViewer(e,t){function h(e,t){if(e==MSG.ART)$(c.find(".albumart")).attr("src",t===""?"no-art.jpeg":t);else{var r=n[e];$(c.find("."+r+" .value")).text(t)}}function p(){var e=new Date,t=Math.round((e.getTime()-s)/1e3),n=Math.floor(t/60),r=t%60;c.find(".timepoint").text(n+":"+(r<=9?"0":"")+r);if(o>0){var i=Math.round(t*1e4/o)/100;c.find(".progressbar").css("width",i+"%")}}function d(e,t){c.find(".offline").hide(),c.find(".idle").hide(),c.find(".playing").show(),c.find(".playbackstatus.paused").toggle(e==MSG.PAUSED),c.find(".playbackstatus.stalled").toggle(e==MSG.STALLED),e==MSG.PLAYING?typeof a=="undefined"&&(a=setInterval(p,1e3)):typeof a!="undefined"&&(clearInterval(a),a=undefined);var n=new Date,r=t.split(" ")[0].split("/");c.find(".duration").text(r[1]);var i=r[0].split(":"),u=r[1].split(":"),f=parseInt(i[0],10)*60+parseInt(i[1],10);o=parseInt(u[0],10)*60+parseInt(u[1],10),s=n.getTime()-f*1e3,p()}function v(){l=new PianoConnection(e,function(){l.subscribe([MSG.PLAYING,MSG.PAUSED,MSG.STALLED],d,!1),l.subscribe(MSG.STOPPED,function(e){c.find(".offline").hide(),c.find(".playing").hide(),c.find(".idle").show()},!1),l.subscribe(MSG.NOSTATION,function(e,t,n){c.find(".stationname .value").html("&nbsp;")},!1),l.subscribe(MSG.SELECTEDSTATION,function(e,t,n){var r=n.split(/\s+/).slice(1);c.find(".stationname .value").text(r.join(" "))},!1),l.subscribe([MSG.ALBUM,MSG.ARTIST,MSG.SONG,MSG.ART,MSG.STATION],function(e,t,n){h(e,n)}),l.request_time_status(),l.send_command("status")},function(){c.find(".idle").hide(),c.find(".playing").hide(),c.find(".offline").show(),l=undefined})}var n={112:"albumname",113:"artistname",114:"trackname",115:"songstation"},r=!1,i=!1,s=0,o=0,u=undefined,a=undefined,f=!1,l,c=undefined;return c=$("#"+(typeof t=="undefined"?"pianod":t)),c.find(".playbackstatus").hide(),c.find(".idle").hide(),c.find(".playing").hide(),c.find(".offline").show(),c.show(),v(),u=setInterval(function(){typeof l=="undefined"&&v()},3005),{destroy:function(){clearInterval(u),typeof a!="undefined"&&clearInterval(a),c.hide()}}}MSG={WELCOME:100,PLAYING:101,PAUSED:102,STOPPED:103,INTERTRACK:104,TRACKCOMPLETE:105,STALLED:106,NOSTATION:108,SELECTEDSTATION:109,ID:111,ALBUM:112,ARTIST:113,SONG:114,STATION:115,RATING:116,URL:117,ART:118,GENRE:119,MYRATING:120,EXPLANATION:121,YELL:131,ACTIVITY:132,NEWS:133,MIX_CHANGED:134,STATIONS_CHANGED:135,PRIVILEGES:136,USERRATINGS_CHANGED:137,VOLUME:141,INFO_START:100,INFO_END:199,SUCCESS_START:200,SUCCESS_END:299,DATA_START:203,DATA_END:204,DETAIL_START:300,DETAIL_END:399,ERROR_START:400,WRONG_STATE:405,ERROR_END:499,FAILURE_START:500,FAILURE_END:599};